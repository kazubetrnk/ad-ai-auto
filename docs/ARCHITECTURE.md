# 🤖 Ad AI Auto — システム設計図

## 1. 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    ミスターKK (iPhone)                     │
│                  Telegram / Web UI                        │
└─────────────┬───────────────────────────┬───────────────┘
              │ 指示・承認                 │ レポート・アラート
              ▼                           ▲
┌─────────────────────────────────────────────────────────┐
│                   🎩 AIクルー (OpenClaw)                  │
│              Mac mini — 司令塔・オーケストレーター           │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ タスク     │  │ スケジュー │  │ 承認      │              │
│  │ ルーター   │  │ ラー      │  │ マネージャー│              │
│  └─────┬────┘  └─────┬────┘  └─────┬────┘              │
│        │             │             │                     │
└────────┼─────────────┼─────────────┼─────────────────────┘
         │             │             │
         ▼             ▼             ▼
┌─────────────────────────────────────────────────────────┐
│                  AIエンジン層                              │
│                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ 広告文       │  │ パフォーマンス │  │ オーディエンス │     │
│  │ ジェネレーター │  │ アナライザー  │  │ アナライザー   │     │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │
│         │               │               │              │
│  ┌──────┴──────┐  ┌──────┴──────┐  ┌──────┴──────┐     │
│  │ 入札         │  │ 予算配分     │  │ クリエイティブ │     │
│  │ オプティマイザー│  │ オプティマイザー│  │ テスター     │     │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │
│         │               │               │              │
└─────────┼───────────────┼───────────────┼──────────────┘
          │               │               │
          ▼               ▼               ▼
┌─────────────────────────────────────────────────────────┐
│                  広告プラットフォーム連携層                  │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐ │
│  │ Google    │  │ Meta     │  │ TikTok   │  │ LINE   │ │
│  │ Ads API  │  │ Ads API  │  │ Ads API  │  │ Ads    │ │
│  └──────────┘  └──────────┘  └──────────┘  └────────┘ │
│                                                          │
└─────────────────────────────────────────────────────────┘
          │               │               │
          ▼               ▼               ▼
┌─────────────────────────────────────────────────────────┐
│                  データストア                              │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ SQLite   │  │ ログ      │  │ キャッシュ │              │
│  │ (メインDB) │  │ (JSON)   │  │ (Redis?)  │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
```

---

## 2. コア機能モジュール

### 2.1 広告文ジェネレーター
```
入力                        処理                         出力
─────────────────────────────────────────────────────────────
製品情報          ──→  AIプロンプト生成    ──→  Google RSA広告
ターゲット情報    ──→  コピー生成          ──→  Meta広告コピー
USP・競合情報     ──→  バリデーション      ──→  TikTok広告コピー
過去の成績データ  ──→  スコアリング        ──→  LINE広告コピー
                  ──→  A/Bバリエーション   ──→  バリエーション3-5個
```

**文字数制限自動チェック:**
| プラットフォーム | 要素 | 上限 |
|----------------|------|------|
| Google RSA | 見出し | 30文字 × 最大15個 |
| Google RSA | 説明文 | 90文字 × 最大4個 |
| Meta | 本文 | 125文字推奨 |
| Meta | 見出し | 40文字推奨 |
| TikTok | テキスト | 100文字推奨 |

### 2.2 パフォーマンスアナライザー
```
┌────────────────┐
│ データ収集       │  ← Google/Meta/TikTok APIから毎日取得
│ (日次自動)       │
└───────┬────────┘
        ▼
┌────────────────┐
│ 指標計算         │  CTR, CPC, CPA, ROAS, CVR
└───────┬────────┘
        ▼
┌────────────────┐
│ AI分析          │  トレンド検出、異常検知、機会発見
└───────┬────────┘
        ▼
┌────────────────┐
│ アクション提案   │  入札変更、予算調整、一時停止、新広告文提案
└───────┬────────┘
        ▼
┌────────────────┐
│ 承認フロー       │  Telegram → ミスターKK → 承認/却下
└───────┬────────┘
        ▼
┌────────────────┐
│ 自動実行         │  承認されたアクションをAPI経由で実行
└────────────────┘
```

### 2.3 入札オプティマイザー
```
ルールベース（即時）:
  IF ROAS < 1.0 AND 費用 > ¥5,000  → 🔴 入札50%ダウン or 一時停止
  IF ROAS > 5.0 AND 予算消化 > 90%  → 🟢 予算20%アップ提案
  IF CTR < 0.5%                     → 🟡 広告文改善を提案
  IF CPC > 目標CPA × 0.5           → 🔴 入札引き下げ
  IF CV = 0 AND 費用 > ¥10,000     → 🔴 一時停止提案

AI分析（日次）:
  パフォーマンスデータ全体を分析
  → 相関関係の発見
  → 曜日・時間帯パターンの検出
  → 競合の影響分析
  → 中長期トレンド予測
```

### 2.4 予算配分オプティマイザー
```
総予算: ¥100,000/日

現在の配分:              AI推奨の配分:
┌─────────┬────────┐    ┌─────────┬────────┐
│ Camp A  │ ¥40,000│    │ Camp A  │ ¥55,000│ ← ROAS高い、もっと投下
│ Camp B  │ ¥30,000│    │ Camp B  │ ¥15,000│ ← ROAS低い、縮小
│ Camp C  │ ¥30,000│    │ Camp C  │ ¥30,000│ ← 安定、維持
└─────────┴────────┘    └─────────┴────────┘
```

---

## 3. 自動化フロー

### 3.1 新キャンペーン作成フロー
```
ミスターKK: 「新商品Xの広告キャンペーン作って」
     │
     ▼
🎩 AIクルー:
     ├── 1. 製品情報をヒアリング（対話 or 自動取得）
     ├── 2. ターゲットオーディエンス分析
     ├── 3. 競合広告リサーチ
     ├── 4. 広告文を5パターン生成
     ├── 5. 予算・入札戦略を提案
     ├── 6. Telegramで承認リクエスト送信
     │       ┌──────────────────────┐
     │       │ 📝 新キャンペーン提案   │
     │       │                      │
     │       │ 商品: X              │
     │       │ 予算: ¥30,000/日     │
     │       │ 広告文: 5パターン     │
     │       │                      │
     │       │ [✅ 承認] [📝 修正] [❌ 却下] │
     │       └──────────────────────┘
     ├── 7. 承認後 → API経由で自動入稿
     └── 8. 入稿完了通知
```

### 3.2 日次自動運用フロー（毎朝8:00）
```
⏰ 08:00 cronトリガー
     │
     ├── 1. 全プラットフォームからデータ取得
     │       Google Ads + Meta Ads + TikTok Ads
     │
     ├── 2. パフォーマンス集計
     │       ├── キャンペーン別
     │       ├── 広告グループ別
     │       └── 広告文別
     │
     ├── 3. AI分析
     │       ├── 異常検知（急激なCPC上昇等）
     │       ├── トレンド分析
     │       └── 改善機会の発見
     │
     ├── 4. 自動アクション（ルールベース）
     │       ├── 🔴 緊急停止（ROAS < 0.5 & 高費用）
     │       └── 🟢 軽微な入札調整（±10%以内）
     │
     ├── 5. 承認待ちアクション
     │       ├── 🟡 予算変更（±20%以上）
     │       ├── 🟡 新広告文テスト開始
     │       └── 🟡 キャンペーン一時停止
     │
     └── 6. Telegramレポート送信
             ┌──────────────────────────────┐
             │ 📊 日次レポート 2026/02/28     │
             │                              │
             │ 🟢 キャンプA  ¥15,000  ROAS 4.2x │
             │ 🟡 キャンプB  ¥8,000   ROAS 1.8x │
             │ 🔴 キャンプC  ¥12,000  ROAS 0.7x │
             │                              │
             │ 💰 合計: ¥35,000  CV: 28件    │
             │                              │
             │ ⚠️ 1件の要対応アクションあり    │
             │ [📋 詳細] [✅ 全承認]          │
             └──────────────────────────────┘
```

### 3.3 リアルタイムアラートフロー
```
常時監視（15分間隔）:
     │
     ├── CPC急上昇（+50%以上） → 💸 即時アラート
     ├── 予算消化ペース異常     → 💰 予算アラート
     ├── CV急減（-50%以上）    → 📉 パフォーマンスアラート
     ├── 広告不承認            → 🚨 エラーアラート
     └── ROAS目標達成          → ✨ 好機アラート
```

---

## 4. データモデル

### 4.1 SQLiteスキーマ
```sql
-- キャンペーン管理
CREATE TABLE campaigns (
    id TEXT PRIMARY KEY,
    platform TEXT,              -- google, meta, tiktok, line
    platform_campaign_id TEXT,
    name TEXT,
    status TEXT,                -- active, paused, ended
    daily_budget REAL,
    target_roas REAL,
    target_cpa REAL,
    created_at DATETIME,
    updated_at DATETIME
);

-- 日次パフォーマンス
CREATE TABLE daily_metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    campaign_id TEXT,
    date DATE,
    impressions INTEGER,
    clicks INTEGER,
    cost REAL,
    conversions REAL,
    revenue REAL,
    ctr REAL,
    cpc REAL,
    cpa REAL,
    roas REAL,
    FOREIGN KEY (campaign_id) REFERENCES campaigns(id)
);

-- 広告コピー
CREATE TABLE ad_copies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    campaign_id TEXT,
    platform TEXT,
    copy_type TEXT,             -- headline, description, primary_text
    content TEXT,
    status TEXT,                -- draft, active, paused, archived
    performance_score REAL,     -- AI評価スコア
    created_at DATETIME,
    FOREIGN KEY (campaign_id) REFERENCES campaigns(id)
);

-- 最適化アクションログ
CREATE TABLE optimization_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    campaign_id TEXT,
    action_type TEXT,           -- bid_change, budget_change, pause, new_copy
    status TEXT,                -- proposed, approved, rejected, executed
    details_json TEXT,
    proposed_at DATETIME,
    decided_at DATETIME,
    executed_at DATETIME,
    FOREIGN KEY (campaign_id) REFERENCES campaigns(id)
);

-- AI分析レポート
CREATE TABLE ai_reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_type TEXT,           -- daily, weekly, alert
    content TEXT,
    insights_json TEXT,
    created_at DATETIME
);
```

---

## 5. 技術スタック

| レイヤー | 技術 | 理由 |
|---------|------|------|
| 言語 | Python 3.12+ | API SDK充実、AI連携容易 |
| AI | Anthropic Claude API | 日本語広告文の品質 |
| AI（バックアップ） | OpenAI GPT-4o | フォールバック |
| DB | SQLite | セルフホスト、軽量、十分な性能 |
| スケジューラー | OpenClaw Cron | 既存インフラ活用 |
| 通知 | Telegram Bot API | 既存Bot活用 |
| Google広告 | google-ads Python SDK | 公式SDK |
| Meta広告 | facebook-business SDK | 公式SDK |
| 実行環境 | Mac mini (常時稼働) | 既存インフラ |
| バージョン管理 | GitHub | BKStock/b-ai-ad-engine |

---

## 6. セキュリティ

- APIキーは `.env` ファイルで管理（gitignore済み）
- 広告の作成・変更は承認フロー必須（自動実行は軽微な調整のみ）
- 日予算上限を設定（暴走防止）
- 全アクションをoptimization_logに記録（監査証跡）
- Telegram通知で全変更をリアルタイム通知

---

## 7. 開発フェーズ

### Phase 1 ✅ 基盤構築
- [x] リポジトリfork & セットアップ
- [x] Google Ads / Meta Ads APIクライアント
- [x] AI広告文ジェネレーター
- [x] AI入札オプティマイザー
- [x] Telegram通知モジュール

### Phase 2: コア自動化
- [ ] SQLiteデータベース構築
- [ ] 日次データ収集パイプライン
- [ ] AI広告文生成 → バリデーション → Telegram承認フロー
- [ ] 日次パフォーマンスレポート自動配信
- [ ] OpenClaw cronジョブ設定

### Phase 3: スマート最適化
- [ ] ルールベース自動最適化エンジン
- [ ] AI駆動の入札・予算最適化
- [ ] A/Bテスト自動管理
- [ ] 異常検知アラート（15分間隔）

### Phase 4: 拡張
- [ ] TikTok Ads対応
- [ ] LINE Ads対応
- [ ] Webダッシュボード（Streamlit or Next.js）
- [ ] 複数アカウント管理
- [ ] レポートPDF自動生成

---

## 8. コスト見積もり

| 項目 | 月額概算 |
|------|---------|
| Anthropic API（広告文生成 + 分析） | ~$10-30 |
| Mac mini電気代 | ~¥500 |
| Google Ads API | 無料 |
| Meta Ads API | 無料 |
| Telegram Bot | 無料 |
| **合計** | **~¥2,000-5,000/月** |

※広告出稿費は別途
